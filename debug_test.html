<!DOCTYPE html>
<html>
<head>
    <title>ScriptEngine Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        textarea { width: 100%; height: 200px; }
        button { padding: 10px 20px; margin: 10px 0; }
        #output { background: #000; color: #0f0; padding: 10px; min-height: 200px; white-space: pre; }
        #debug { background: #333; color: #ff0; padding: 10px; min-height: 100px; white-space: pre; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ScriptEngine Debug Test</h1>
    <p>This tests the ScriptEngine in isolation, without the full RetrOS system.</p>

    <h3>Script:</h3>
    <textarea id="script">print Hello World</textarea>

    <br>
    <button id="runBtn">Run Script</button>
    <button id="clearBtn">Clear</button>
    <button id="loadTestBtn">Load Test Suite</button>

    <h3>Output:</h3>
    <div id="output"></div>

    <h3>Debug Log:</h3>
    <div id="debug"></div>

    <script type="module">
        // Debug logger - defined first
        function debugLog(msg) {
            document.getElementById('debug').textContent += msg + '\n';
            console.log('[DEBUG]', msg);
        }

        // We'll use EventBus subscription instead of console.log override

        debugLog('Page loaded, setting up...');

        // Import ScriptEngine and EventBus (to test full integration)
        debugLog('Importing modules...');

        let ScriptEngine = null;
        let EventBus = null;

        try {
            debugLog('Importing EventBus...');
            const eventModule = await import('./core/EventBus.js');
            EventBus = eventModule.default;
            debugLog('EventBus imported: ' + typeof EventBus);

            // Test subscribing to script:output like ScriptRunner does
            debugLog('Setting up script:output subscription...');
            EventBus.on('script:output', ({ message }) => {
                debugLog('Received script:output: ' + message);
                document.getElementById('output').textContent += message + '\n';
            });

            // Wildcard subscription like ScriptRunner has
            debugLog('Setting up wildcard subscription...');
            let eventCount = 0;
            EventBus.on('*', (payload, meta, event) => {
                eventCount++;
                debugLog(`Event #${eventCount}: ${event.name}`);
            });

            debugLog('Importing ScriptEngine...');
            const module = await import('./core/ScriptEngine.js');
            ScriptEngine = module.default;
            debugLog('ScriptEngine imported successfully');
            debugLog('ScriptEngine type: ' + typeof ScriptEngine);
            debugLog('ScriptEngine.run type: ' + typeof ScriptEngine?.run);

            // Expose for debugging
            window.ScriptEngine = ScriptEngine;
            window.EventBus = EventBus;
        } catch(e) {
            debugLog('Import error: ' + e.message);
            debugLog('Stack: ' + e.stack);
            console.error(e);
        }

        // Run test function
        async function runTest() {
            if (!ScriptEngine) {
                debugLog('ERROR: ScriptEngine not loaded');
                return;
            }

            const script = document.getElementById('script').value;
            const output = document.getElementById('output');
            output.textContent = '';

            debugLog('Starting script execution...');
            debugLog('Script: "' + script + '"');

            try {
                debugLog('Calling ScriptEngine.run...');
                const result = await ScriptEngine.run(script);
                debugLog('Execution complete');
                debugLog('Result: ' + JSON.stringify(result));
            } catch(e) {
                debugLog('Execution error: ' + e.message);
                debugLog('Stack: ' + e.stack);
                console.error(e);
            }
        }

        // Set up button handlers
        document.getElementById('runBtn').addEventListener('click', runTest);
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('output').textContent = '';
            document.getElementById('debug').textContent = '';
        });
        document.getElementById('loadTestBtn').addEventListener('click', async () => {
            debugLog('Loading test suite...');
            try {
                const response = await fetch('./apps/ScriptRunner.js');
                const text = await response.text();
                // Extract the test script from ScriptRunner.js
                const match = text.match(/const sampleScript = `([\s\S]*?)`;/);
                if (match) {
                    document.getElementById('script').value = match[1];
                    debugLog('Test suite loaded: ' + match[1].length + ' characters');
                } else {
                    debugLog('Could not find test script in ScriptRunner.js');
                }
            } catch(e) {
                debugLog('Error loading test suite: ' + e.message);
            }
        });

        debugLog('Setup complete. Ready to run scripts.');
    </script>
</body>
</html>
