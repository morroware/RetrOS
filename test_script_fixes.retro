# Script Engine Fixes Validation Test
# Tests the critical fixes we implemented

print ═══════════════════════════════════════════════
print  SCRIPT ENGINE FIXES VALIDATION TEST
print ═══════════════════════════════════════════════
print

# Test 1: Expression Parser with Operator Precedence
print [Test 1] Expression Parser with Operator Precedence
set $result = 5 + 3 * 2
if $result == 11 then {
    print   ✓ PASS: 5 + 3 * 2 = $result (precedence works!)
} else {
    print   ✗ FAIL: Expected 11, got $result
}

set $result = (5 + 3) * 2
if $result == 16 then {
    print   ✓ PASS: (5 + 3) * 2 = $result (parentheses work!)
} else {
    print   ✗ FAIL: Expected 16, got $result
}

print

# Test 2: Escaped Quotes in Strings
print [Test 2] Escaped Quotes in Strings
set $msg = "He said \"hello\" to me"
set $expected = "He said \"hello\" to me"
if $msg == $expected then {
    print   ✓ PASS: Escaped quotes work
} else {
    print   ✗ FAIL: Escaped quotes broken
}

print

# Test 3: Function Scoping (local variables)
print [Test 3] Function Scoping
set $global = 100

def testScope($param) {
    set $local = 42
    set $result = $param + $local + $global
    return $result
}

set $funcResult = call testScope 8
if $funcResult == 150 then {
    print   ✓ PASS: Function scoping works (8 + 42 + 100 = $funcResult)
} else {
    print   ✗ FAIL: Expected 150, got $funcResult
}

# $local should NOT exist in global scope
set $localExists = call isNull $local
if $localExists == true then {
    print   ✓ PASS: Local variable properly scoped (not in global)
} else {
    print   ✗ FAIL: Local variable leaked to global scope!
}

print

# Test 4: Loop Variable Isolation
print [Test 4] Loop Variable Isolation
set $i = 999

loop 3 {
    print   Loop iteration: $i
}

if $i == 999 then {
    print   ✓ PASS: User $i preserved after loop ($i)
} else {
    print   ✗ FAIL: Loop $i overwrote user variable (got $i)
}

print

# Test 5: Nested Functions
print [Test 5] Nested Function Scopes
set $x = 10

def outer() {
    set $y = 20
    def inner() {
        set $z = 30
        return $x + $y + $z
    }
    return call inner
}

set $nested = call outer
if $nested == 60 then {
    print   ✓ PASS: Nested functions work (10 + 20 + 30 = $nested)
} else {
    print   ✗ FAIL: Expected 60, got $nested
}

print

# Test 6: Type Coercion
print [Test 6] Type Coercion
set $empty = ""
set $emptyNum = $empty + 0
if $emptyNum == 0 then {
    print   ✓ PASS: Empty string to number coercion works
} else {
    print   ✗ FAIL: Empty string coercion broken
}

print

# Test 7: Complex Expression
print [Test 7] Complex Expression with Function Call
set $complex = call abs(-5) + 3 * 2
if $complex == 11 then {
    print   ✓ PASS: abs(-5) + 3 * 2 = $complex
} else {
    print   ✗ FAIL: Expected 11, got $complex
}

print

print ═══════════════════════════════════════════════
print  ALL VALIDATION TESTS COMPLETE!
print ═══════════════════════════════════════════════
